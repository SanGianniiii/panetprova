<!DOCTYPE html>
<html lang="it">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
Â  <link rel="manifest" href="manifest.json">
Â  Â  <meta name="theme-color" content="#3F51B5"> 
Â  <title>Ordini Post - PROVA</title>
Â <style>
Â  Â  /* COLORI TEMA NATIVITÃ€ */
Â  Â  :root {
Â  Â  Â  --colore-principale: #FFD700; /* Oro Stella Cometa */
Â  Â  Â  --colore-secondario: #3F51B5; /* Blu Regale (cielo notte/manto) */
Â  Â  Â  --colore-testo: #212121; /* Grigio scuro per leggibilitÃ  */
Â  Â  Â  --sfondo-chiaro: #FAFAFA; /* Bianco/Crema leggero */
Â  Â  Â  --sfondo-gradiente: linear-gradient(to bottom, #FAFAFA, #E8EAF6); /* Leggera transizione Blu/Bianco */
Â  Â  }

Â  Â  body {
Â  Â  Â  font-family: "Segoe UI", sans-serif;
Â  Â  Â  background: var(--sfondo-gradiente);
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 2rem;
Â  Â  Â  color: var(--colore-testo);Â 
Â  Â  }
Â  Â Â 
Â  Â  #splash {
Â  Â  Â  position: fixed;
Â  Â  Â  top: 0; left: 0;
Â  Â  Â  width: 100vw; height: 100vh;
Â  Â  Â  background-color: var(--colore-secondario); /* Blu Notte/Regale */
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  z-index: 99999;
Â  Â  Â  opacity: 1;
Â  Â  Â  transition: opacity 1s ease-out;
Â  Â  }
Â  Â  #splash img {
Â  Â  Â  width: 400px;
Â  Â  Â  height: 400px;
Â  Â  Â  animation: fadeIn 1s ease-in-out;Â 
Â  Â  }
Â  Â  @keyframes fadeIn {
Â  Â  Â  from { opacity: 0; transform: scale(0.8); }
Â  Â  Â  to { opacity: 1; transform: scale(1); }
Â  Â  }
Â  Â Â 
Â  Â  header {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 1rem;
Â  Â  Â  justify-content: center;
Â  Â  Â  margin-bottom: 2rem;
Â  Â  }
Â  Â  header img {
Â  Â  Â  width: 120px;
Â  Â  Â  height: 120px;
Â  Â  }
Â  Â  h2, h3 {
Â  Â  Â  margin: 0;
Â  Â  Â  font-size: 2.4rem;
Â  Â  Â  color: var(--colore-principale); /* Titoli in Oro */
Â  Â  Â  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2); /* Leggera ombra per l'Oro */
Â  Â  }
Â  Â  h3 {
Â  Â  Â  Â font-size: 1.5rem;
Â  Â  }
Â  Â Â 
Â  Â  /* INPUT E SELECT */
Â  Â  select, input[type="number"], button {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 0.7rem;
Â  Â  Â  margin-top: 1rem;
Â  Â  Â  font-size: 1rem;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  border: 1px solid var(--colore-principale); /* Bordo Oro */
Â  Â  Â  color: var(--colore-testo);
Â  Â  }
Â  Â Â 
Â  Â  /* BOTTONI (Blu Regale con testo Oro) */
Â  Â  button {
Â  Â  Â  background-color: var(--colore-secondario);Â 
Â  Â  Â  color: white;
Â  Â  Â  border: none;
Â  Â  Â  margin-top: 1.5rem;
Â  Â  Â  font-weight: bold;
Â  Â  Â  transition: background 0.3s;
Â  Â  }
Â  Â  button:hover {
Â  Â  Â  background-color: #303F9F; /* Blu piÃ¹ scuro al passaggio */
Â  Â  }
Â  Â Â 
Â  Â  /* TABELLA */
Â  Â  table {
Â  Â  Â  width: 100%;
Â  Â  Â  border-collapse: collapse;
Â  Â  Â  background-color: white;
Â  Â  Â  margin-top: 1rem;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  overflow: hidden;
Â  Â  Â  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);Â 
Â  Â  }
Â  Â  th, td {
Â  Â  Â  padding: 0.8rem;
Â  Â  Â  text-align: center;
Â  Â  Â  border-bottom: 1px solid #E0E0E0;
Â  Â  }
Â  Â  th {
Â  Â  Â  background-color: var(--colore-secondario); /* Intestazione in Blu Regale */
Â  Â  Â  color: var(--colore-principale); /* Testo intestazione in Oro */
Â  Â  Â  font-weight: bold;
Â  Â  }
Â  Â Â 
Â  Â  /* --- 
    ğŸ”” QUI LA CORREZIONE FONDAMENTALE ğŸ””
    Abbiamo aggiunto 'display: none;' per nascondere i modali all'avvio.
    --- 
    */
Â  Â  #modal {
Â  Â  Â  display: none; /* <-- CORREZIONE: Aggiunto per nasconderlo */
Â  Â  Â  position: fixed;
Â  Â  Â  top: 0; left: 0;
Â  Â  Â  width: 100%; height: 100%;
Â  Â  Â  background: rgba(0,0,0,0.7);Â 
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  }
    /* NOTA: #modal-riepilogo Ã¨ giÃ  nascosto tramite stile inline nell'HTML, 
       ma questa regola assicura che #modal sia nascosto di default. */
Â  Â Â 
Â  Â  #modal-content {
Â  Â  Â  background: var(--sfondo-chiaro);
Â  Â  Â  padding: 2rem;
Â  Â  Â  border-radius: 10px;
Â  Â  Â  max-width: 90%;
Â  Â  Â  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
Â  Â  }
Â  Â  #modal-content h3 {
Â  Â  Â  color: var(--colore-principale);Â 
Â  Â  }
Â  Â Â 
Â  Â  /* SPINNER */
Â  Â  .spinner {
Â  Â  Â  display: inline-block;
Â  Â  Â  width: 16px;
Â  Â  Â  height: 16px;
Â  Â  Â  vertical-align: middle;
Â  Â  Â  margin-left: 8px;
Â  Â  Â  border: 2px solid var(--colore-principale);
Â  Â  Â  border-top: 2px solid transparent;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  animation: spin 0.8s linear infinite;
Â  Â  }
Â  Â  @keyframes spin { to { transform: rotate(360deg); } }
Â  Â Â 
Â  Â  /* ALTRI STILI RESPONSIVE */
Â  Â  @media (min-width: 768px) {
Â  Â  Â  select, input[type="number"], button {
Â  Â  Â  Â  max-width: 500px;
Â  Â  Â  Â  margin-left: auto;
Â  Â  Â  Â  margin-right: auto;
Â  Â  Â  Â  display: block;
Â  Â  Â  }
Â  Â  }
Â  Â  td input[type="number"] {
Â  Â  Â  max-width: 80px;
Â  Â  Â  box-sizing: border-box;
Â  Â  Â  border-color: var(--colore-secondario);Â 
Â  Â  }
</style>
</head>
<body>
<script type="module">
Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
Â  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";

Â  const firebaseConfig = {
Â  Â  apiKey: "AIzaSyAY8l_GGRWPWi5BFpirUMXd2JN0MVZZpYM",
Â  Â  authDomain: "ordinipost-fcc7f.firebaseapp.com",
Â  Â  projectId: "ordinipost-fcc7f",
Â  Â  storageBucket: "ordinipost-fcc7f.appspot.com",
Â  Â  messagingSenderId: "363847145933",
Â  Â  appId: "1:363847145933:web:d1590848833eb147590c84",
Â  };

Â  const app = initializeApp(firebaseConfig);
Â  const messaging = getMessaging(app);

Â  navigator.serviceWorker
Â  Â  .register('/panetprova/firebase-messaging-sw.js')
Â  Â  .then(() => console.log('âœ… Service Worker registrato'))
Â  Â  .catch(err => console.error('âŒ Errore SW:', err));

Â  onMessage(messaging, (payload) => {
Â  Â  console.log("ğŸ“© Messaggio ricevuto:", payload);
Â  Â  alert(`ğŸ“¢ Notifica: ${payload.notification.title} - ${payload.notification.body}`);
Â  });
</script>

<div id="splash"><img src="logo.png" alt="Logo"></div>

<header>
Â  <img src="logo.png" alt="Logo" />
Â  <h2>WebApp Ordini Post - PROVA</h2>
</header>

<label for="nome">Seleziona Famiglia di Padrini:</label>
<select id="nome">
Â  <option value="">-- Seleziona la tua Famiglia --</option>
Â  <option>Carapezza</option><option>Caruso</option><option>Di Maria</option>
Â  <option>Marino</option><option>Massimino</option><option>Milanese</option>
Â  <option>Murabito</option><option>Nicosia</option><option>Pantellaro</option>
Â  <option>Porto</option><option>Romano</option><option>Ruiz</option>
Â  <option>Scala</option><option>Tanasi</option><option>Zammillo</option>
</select>

<div id="tabella-g">
Â  <h3>DisponibilitÃ  prodotti</h3>
Â  <div id="prodotti"></div>
</div>

<button onclick="confermaOrdine()">Prenota</button>
<button onclick="mostraRiepilogoPrenotazioni()">Riepilogo Prenotazioni</button>

<div id="modal" style="display: none;"> 
Â  <div id="modal-content">
Â  Â  <h3>Conferma ordine</h3>
Â  Â  <pre id="riepilogoModal"></pre>
Â  Â  <div id="messaggioAttesa" style="display:none;color:var(--colore-secondario);font-weight:bold;">
Â  Â  Â  â³ Attendi, il tuo ordine sta per essere processato... <span class="spinner"></span>
Â  Â  </div>
Â  Â  <button onclick="inviaOrdine()">Conferma</button>
Â  Â  <button onclick="chiudiModal()">Annulla</button>
Â  </div>
</div>

<div id="modal-riepilogo" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;">
Â  <div style="background:#fff;padding:20px;border-radius:10px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;">
Â  Â  <h3>Riepilogo Prenotazioni</h3>
Â  Â  Â  Â  <div id="spinner-riepilogo" style="display:none;color:var(--colore-secondario);font-weight:bold;margin-bottom:1rem;">
Â  Â  Â  Generazione riepilogo in corso... <span class="spinner"></span>
Â  Â  </div>
Â  Â  <pre id="contenuto-riepilogo" style="white-space: pre-wrap; font-family: monospace;"></pre>
Â  Â  <button onclick="document.getElementById('modal-riepilogo').style.display='none'">Chiudi</button>
Â  </div>
</div>

<script>
Â  const scriptUrl = "https://script.google.com/macros/s/AKfycbxEDGWC2lozKekZlR1dvIY2_3OZYdPb81-pTN2kBCCag3suzm_ArdGSNqOlPy_hmIQW/exec";
Â  let prodotti = [];
Â  let ordineDaInviare = [];
Â  let riepilogoCorrente = [];

Â  async function caricaProdotti() {
Â  Â  try {
Â  Â  Â  const res = await fetch(scriptUrl + "?action=read");
Â  Â  Â  const data = await res.json();
Â  Â  Â  prodotti = data;
Â  Â  Â  mostraTabella();

Â  Â  Â  const salvato = localStorage.getItem("famiglia");
Â  Â  Â  if (salvato) document.getElementById("nome").value = salvato;
_ Â  } catch (e) {
Â  Â  Â  alert("Errore nel caricamento dei dati: " + e.message);
Â  Â  } finally {
Â  Â  Â  const splash = document.getElementById("splash");
Â  Â  Â  if (splash) {
Â  Â  Â  Â  splash.style.opacity = "0";
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  splash.style.display = "none";
Â  Â  Â  Â  }, 1000); 
Â  Â  Â  }
Â  Â  }
Â  }
Â  function mostraTabella() {
Â  Â  let html = "<table><tr><th>Prodotto</th><th>Disponibile</th><th>QuantitÃ </th></tr>";
Â  Â  prodotti.forEach((p, i) => {
Â  Â  Â  html += `<tr>
Â  Â  Â  Â  <td>${p.tipo}</td>
Â  Â  Â  Â  <td>${p.giacenza}</td>
Â  Â  Â  Â  <td>${p.giacenza <= 0 ? '<span style="color:red;font-weight:bold;">Sold Out</span>' :
Â  Â  Â  Â  `<input type="number" id="quantita-${i}" min="0" max="${p.giacenza}" />`}</td>
Â  Â  Â  </tr>`;
Â  Â  });
Â  Â  html += "</table>";
Â  Â  document.getElementById("prodotti").innerHTML = html;
Â  }

Â  function confermaOrdine() {
Â  Â  const nome = document.getElementById("nome").value.trim();
Â  Â  if (!nome) return alert("Seleziona il nome della tua famiglia.");
Â  Â  localStorage.setItem("famiglia", nome);

Â  Â  const ordine = [];
Â  Â  for (let i = 0; i < prodotti.length; i++) {
Â  Â  Â  const p = prodotti[i];
Â  Â  Â  const input = document.getElementById(`quantita-${i}`);
Â  Â  Â  if (!input) continue;
Â  Â  Â  const qty = parseInt(input.value) || 0;
Â  Â  Â  if (qty > p.giacenza) return alert(`Giacenza insufficiente per ${p.tipo}`);
Â  Â  Â  if (qty > 0) ordine.push({ nome, prodotto: p.tipo, quantita: qty });
Â  Â  }
Â  Â  if (!ordine.length) return alert("Nessun prodotto selezionato.");

Â  Â  let riepilogo = `Famiglia: ${nome}\n\n`;
Â  Â  ordine.forEach(o => riepilogo += `- ${o.prodotto}: ${o.quantita}\n`);
Â  Â  ordineDaInviare = ordine;
Â  Â  document.getElementById("riepilogoModal").innerText = riepilogo;
Â  Â  document.getElementById("modal").style.display = "flex";
Â  }

Â  function chiudiModal() {
Â  Â  document.getElementById("modal").style.display = "none";
Â  Â  document.getElementById("messaggioAttesa").style.display = "none";
Â  }

Â  async function inviaOrdine() {
Â  Â  const attesa = document.getElementById("messaggioAttesa");
Â  Â  attesa.style.display = "block";
Â  Â  try {
Â  Â  Â  const res = await fetch(scriptUrl, {
Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  body: JSON.stringify({ action: "prenota", ordine: ordineDaInviare })
Â  Â  Â  });
Â  Â  Â  await res.json();
Â  Â  Â  alert("âœ… Ordine inviato con successo!");
Â  Â  Â  chiudiModal();
Â  Â  Â  caricaProdotti();
Â  Â  } catch (e) {
Â  Â  Â  alert("Errore invio ordine: " + e.message);
Â  Â  } finally {
Â  Â  Â  attesa.style.display = "none";
Â  Â  }
Â  }

Â  async function mostraRiepilogoPrenotazioni() {
Â  Â  const nominativo = document.getElementById('nome').value.trim();
Â  Â  if (!nominativo) return alert("Seleziona prima un nominativo.");

Â  Â  const spinner = document.getElementById("spinner-riepilogo");
Â  Â  const contenuto = document.getElementById("contenuto-riepilogo");
Â  Â  contenuto.innerHTML = ""; // Svuota il contenuto precedente
Â  Â  spinner.style.display = "block";
Â  Â  document.getElementById('modal-riepilogo').style.display = "flex";

Â  Â  try {
Â  Â  Â  const url = scriptUrl + "?action=riepilogo&nominativo=" + encodeURIComponent(nominativo);
Â  Â  Â  const res = await fetch(url);
Â  Â  Â  const data = await res.json();
Â  Â  Â Â 
Â  Â  Â  riepilogoCorrente = data; // Salva i dati per la funzione di annullamento
Â  Â  Â  spinner.style.display = "none";
Â  Â  Â Â 
Â  Â  Â  const prenotazioniAttive = data.filter(item => item.valore > 0);

Â  Â  Â  if (!prenotazioniAttive.length) {
Â  Â  Â  Â  contenuto.innerText = `Nessuna prenotazione attiva per ${nominativo}.`;
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  let html = `<p>Riepilogo per <strong>${nominativo}</strong>. Inserisci la quantitÃ  che desideri annullare.</p>`;
Â  Â  Â  html += `<table style="width:100%; text-align:center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â <tr><th>Prodotto</th><th>Prenotati</th><th>QtÃ  da Annullare</th></tr>`;
Â  Â  Â Â 
Â  Â  Â  prenotazioniAttive.forEach((item, i) => {
Â  Â  Â  Â  html += `<tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td>${item.prodotto}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td><strong>${item.valore}</strong></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <input type="number" id="annulla-${i}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  min="0" max="${item.valore}" value="0"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  style="width: 70px; padding: 0.4rem; margin-top: 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â </tr>`;
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  html += `</table><br>`;
Â  Â  Â  html += `<button id="btnConfermaAnnullamento" onclick="inviaAnnullamento()">Conferma Annullamenti</button>`;

Â  Â  Â  contenuto.innerHTML = html; 

Â  Â  } catch (err) {
Â  Â  Â  spinner.style.display = "none";
Â  Â  Â  contenuto.innerText = "Errore: " + err.message;
Â  Â  }
Â  }

Â  async function inviaAnnullamento() {
Â  Â  const nome = document.getElementById("nome").value.trim();
Â  Â  const btn = document.getElementById("btnConfermaAnnullamento");
Â  Â Â 
Â  Â  btn.disabled = true;
Â  Â  btn.innerHTML = 'Elaborazione... <span class="spinner"></span>';

Â  Â  const ordineDiAnnullamento = [];
Â  Â  let errore = false;

Â  Â  const prenotazioniAttive = riepilogoCorrente.filter(item => item.valore > 0);

Â  Â  prenotazioniAttive.forEach((item, i) => {
Â  Â  Â  const input = document.getElementById(`annulla-${i}`);
Â  Â  Â  if (input) {
Â  _ Â  Â  Â  const qtyDaAnnullare = parseInt(input.value) || 0;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (qtyDaAnnullare > item.valore) {
Â  Â  Â  Â  Â  alert(`Errore: Non puoi annullare ${qtyDaAnnullare} ${item.prodotto}, ne hai prenotati solo ${item.valore}.`);
Â  Â  Â  Â  Â  errore = true;
Â  Â  Â  Â  }

Â  Â  Â  Â  if (qtyDaAnnullare > 0) {
Â  Â  Â  Â  Â  ordineDiAnnullamento.push({
Â  Â  g Â  Â  Â  Â  nome: nome,
Â  Â  Â  Â  Â  Â  prodotto: item.prodotto,
code Â  Â  Â  Â  Â  quantita: -qtyDaAnnullare // QuantitÃ  negativa
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  });

Â  Â  if (errore) {
Â  Â  Â  btn.disabled = false;
Â  Â  Â  btn.innerHTML = 'Conferma Annullamenti';
Â  Â  Â  return; 
Â  Â  }

Â  Â  if (ordineDiAnnullamento.length === 0) {
Â  Â  Â  alert("Nessuna quantitÃ  da annullare inserita.");
Â  Â  Â  btn.disabled = false;
Â  Â  Â  btn.innerHTML = 'Conferma Annullamenti';
Â  Â  Â  return;
Â  Â  }

Â  Â  try {
Â  Â  Â  const res = await fetch(scriptUrl, {
Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  body: JSON.stringify({ action: "prenota", ordine: ordineDiAnnullamento })
Â  Â  Â  });
Â  Â  Â  await res.json();
Â  Â  Â Â 
      // Messaggio di successo (puoi personalizzare l'emoji)
Â  Â  Â  alert("ğŸ—‘ï¸ Annullamento registrato con successo!");
Â  Â  Â Â 
Â  Â  Â  document.getElementById('modal-riepilogo').style.display = "none";
Â  Â  Â  caricaProdotti();Â 
Â  Â  Â Â 
Â  Â  } catch (e) {
Â  Â  Â  alert("Errore invio annullamento: " + e.message);
Â  Â  Â  btn.disabled = false;
Â  Â  Â  btn.innerHTML = 'Conferma Annullamenti';
Â  Â  }
Â  }
Â Â 
Â  window.onload = caricaProdotti;
</script>
</body>
</html>
