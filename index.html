<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FFD700">
  <title>Versione Beta</title>
  <style>
/* --- STILI BASE --- */
body {
    font-family: "Segoe UI", sans-serif;
    background: linear-gradient(to right, #e8f5e9, #0a1a3f);
    margin: 0;
    padding: 2rem;
    color: #2e7d32;
}

/* --- STILI MODAL DETTAGLIO/RIEPILOGO (Nuovi) --- */
#modal-riepilogo > div, #modal-dettaglio-persone > div {
    max-height: 80vh;
    overflow-y: auto;
}
/* Rimuove lo spazio extra sotto l'intestazione del riepilogo/dettaglio */
#contenuto-riepilogo p, #contenuto-dettaglio h4 {
    margin-top: 0.5rem;
    margin-bottom: 0.8rem;
}
/* Stile per il blocco di dettaglio di una singola persona */
.dettaglio-persona {
    margin-top: 1rem;
    padding: 0.8rem;
    border: 1px solid #a5d6a7;
    border-radius: 5px;
}
.dettaglio-persona h5 {
    margin-top: 0;
    margin-bottom: 0.5rem;
    font-size: 1.4rem;
    color: #0a1a3f;
}
/* Fine STILI MODAL DETTAGLIO/RIEPILOGO */

/* --- STILI SPLASH SCREEN --- */
#splash {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background-color: #0a1a3f;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 99999;
    opacity: 1;
    transition: opacity 1s ease-out;
}
#splash video {
    width: 100%;
    max-width: 500px;
    height: auto;
    border-radius: 15px;
    animation: fadeIn 1s ease-in-out;
}
@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
}

/* --- STILI HEADER e FORM --- */
header {
    display: flex;
    align-items: center;
    gap: 1rem;
    justify-content: center;
    margin-bottom: 2rem;
}
header img {
    width: 120px;
    height: 120px;
}
h2 {
    margin: 0;
    font-size: 2.4rem;
}

/* INPUT e SELECT: UNIFICATO con input[type="text"] */
select, input[type="number"], input[type="text"], button {
    width: 100%;
    padding: 0.7rem;
    margin-top: 1rem;
    font-size: 1rem;
    border-radius: 6px;
    border: 1px solid #a5d6a7;
    box-sizing: border-box; /* Importante per l'allineamento */
}

/* --- STILI TABELLA --- */
table {
    width: 100%;
    border-collapse: collapse;
    background-color: white;
    margin-top: 1rem;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0, 128, 0, 0.2);
}
th, td {
    padding: 0.8rem;
    text-align: center;
    border-bottom: 1px solid #e0f2f1;
}
th {
    background-color: #a5d6a7;
    color: white;
}
/* INPUT SPECIFICI PER TABELLA (PiÃ¹ piccoli) */
td input[type="number"], td input[type="text"] {
    max-width: 80px;
    box-sizing: border-box;
    margin: 0;
    padding: 0.4rem;
}
td input[type="text"] {
    max-width: 120px; /* Un po' piÃ¹ di spazio per la nota */
}

/* --- STILI PULSANTI --- */
button {
    background-color: #2e7d32;
    color: white;
    border: none;
    margin-top: 1.5rem;
    font-weight: bold;
    transition: background 0.3s;
}
button:hover {
    background-color: #1b5e20;
}
/* Stili per i pulsanti all'interno dei modal */
#modal-content button, #modal-riepilogo button, #modal-dettaglio-persone button {
    width: auto;
    margin: 1rem 0 0 0;
    flex-grow: 1;
}


/* --- STILI MODAL GENERICI --- */
#modal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
}
#modal-content {
    background: white;
    padding: 2rem;
    border-radius: 10px;
    max-width: 90%;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
#modal-content h3 {
    margin-top: 0;
    color: #2e7d32;
}


/* --- STILI VARI / MEDIA QUERY --- */
@media (min-width: 768px) {
    select, input[type="number"], button {
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
        display: block;
    }
}
.spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #2e7d32;
    border-top: 2px solid transparent;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    vertical-align: middle;
    margin-left: 8px;
}
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAY8l_GGRWPWi5BFpirUMXd2JN0MVZZpYM",
    authDomain: "ordinipost-fcc7f.firebaseapp.com",
    projectId: "ordinipost-fcc7f",
    storageBucket: "ordinipost-fcc7f.appspot.com",
    messagingSenderId: "363847145933",
    appId: "1:363847145933:web:d1590848833eb147590c84",
  };

  const app = initializeApp(firebaseConfig);
  const messaging = getMessaging(app);

  navigator.serviceWorker
    .register('/panetprova/firebase-messaging-sw.js')
    .then(() => console.log('âœ… Service Worker registrato'))
    .catch(err => console.error('âŒ Errore SW:', err));

  onMessage(messaging, (payload) => {
    console.log("ğŸ“© Messaggio ricevuto:", payload);
    alert(`ğŸ“¢ Notifica: ${payload.notification.title} - ${payload.notification.body}`);
  });
</script>

<div id="splash">
    <video autoplay muted loop playsinline>
        <source src="jhs.mp4" type="video/mp4">
        <img src="logo.png" alt="Logo"> 
    </video>
</div>

<header>
  <img src="logo.png" alt="Logo" />
  <h2>WebApp Versione Beta2</h2>
</header>

<label for="nome">Seleziona Famiglia di Padrini:</label>
<select id="nome">
  <option value="">-- Seleziona la tua Famiglia --</option>
  <option>Carapezza</option><option>Caruso</option><option>Di Maria</option>
  <option>Marino</option><option>Massimino</option><option>Milanese</option>
  <option>Murabito</option><option>Nicosia</option><option>Pantellaro</option>
  <option>Porto</option><option>Romano</option><option>Ruiz</option>
  <option>Scala</option><option>Tanasi</option><option>Zammillo</option>
</select>

<div id="tabella-g">
  <h3>DisponibilitÃ  prodotti</h3>
  <div id="prodotti"></div>
</div>

<button onclick="confermaOrdine()">Prenota</button>
<button onclick="mostraRiepilogoPrenotazioni()">Riepilogo Prenotazioni</button>

<div id="modal">
  <div id="modal-content">
    <h3>Conferma ordine</h3>
    <pre id="riepilogoModal"></pre>
    <div id="messaggioAttesa" style="display:none;color:#2e7d32;font-weight:bold;">
      â³ Attendi, il tuo ordine sta per essere processato... <span class="spinner"></span>
    </div>
    <button onclick="inviaOrdine()">Conferma</button>
    <button onclick="chiudiModal()">Annulla</button>
  </div>
</div>

<div id="modal-riepilogo" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;">
Â  <div style="background:#fff;padding:20px;border-radius:10px;max-width:800px;width:90%;"> 
Â  Â  <h3>Riepilogo Prenotazioni</h3>
Â  Â  <div id="spinner-riepilogo" style="display:none;color:#2e7d32;font-weight:bold;margin-bottom:1rem;">
Â  Â  Â  Generazione riepilogo in corso... <span class="spinner"></span>
Â  Â  </div>
Â  Â  <div id="contenuto-riepilogo" style="white-space: pre-wrap; font-family: monospace;"></div>
Â  Â  Â  </div>
</div>

<div id="modal-dettaglio-persone" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center; z-index: 10000;">
Â  <div style="background:#fff;padding:20px;border-radius:10px;max-width:800px;width:90%;">
Â  Â  <h3>Dettaglio Ordini per Persona</h3>
Â  Â  <div id="spinner-dettaglio" style="display:none;color:#2e7d32;font-weight:bold;margin-bottom:1rem;">
Â  Â  Â  Caricamento dettaglio in corso... <span class="spinner"></span>
Â  Â  </div>
Â  Â  <div id="contenuto-dettaglio" style="white-space: pre-wrap; font-family: 'Segoe UI', sans-serif;"></div>
Â  Â  <div id="pulsanti-dettaglio" style="display: flex; justify-content: space-between; gap: 10px;">
Â  Â  Â  <button id="btnApplicaModifiche" onclick="inviaModificaDettaglio()" style="flex-grow: 1; background-color: #2e7d32;">Applica Modifiche Ordini</button>
Â  Â  Â  <button onclick="document.getElementById('modal-dettaglio-persone').style.display='none'" style="flex-grow: 1; background-color: #6c757d;">Chiudi</button>
Â  Â  </div>
Â  </div>
</div>
  
<script>
  const scriptUrl = "https://script.google.com/macros/s/AKfycbxEDGWC2lozKekZlR1dvIY2_3OZYdPb81-pTN2kBCCag3suzm_ArdGSNqOlPy_hmIQW/exec";
  let prodotti = [];
  let ordineDaInviare = [];
  let riepilogoCorrente = [];

 async function caricaProdotti() {
    try {
      const res = await fetch(scriptUrl + "?action=read");
      const data = await res.json();
      prodotti = data;
      mostraTabella();

      const salvato = localStorage.getItem("famiglia");
      if (salvato) document.getElementById("nome").value = salvato;
    } catch (e) {
      alert("Errore nel caricamento dei dati: " + e.message);
    } finally {
      // Gestione Splash Screen con Video
      const splash = document.getElementById("splash");
      if (splash) {
        // TEMPO AGGIUNTIVO PER LA VISUALIZZAZIONE DEL VIDEO (3000ms = 3 secondi)
        const delayBeforeFadeOut = 3000; 

        setTimeout(() => {
            splash.style.opacity = "0"; // Inizia la dissolvenza (dura 1s grazie al CSS)
            
            // Rimuove l'elemento dopo la fine della dissolvenza (1000ms)
            setTimeout(() => {
                splash.style.display = "none";
            }, 1000); 
            
        }, delayBeforeFadeOut);
      }
    }
  }

 function mostraTabella() {
  let html = "<table><tr><th>Prodotto</th><th>Disponibile</th><th>QuantitÃ </th><th>Nota</th></tr>"; 
  prodotti.forEach((p, i) => {
    html += `<tr>
                <td>${p.tipo}</td>
                <td>${p.giacenza}</td>
                <td>${
                  p.giacenza <= 0
                    ? '<span style="color:red; font-weight:bold;">Sold Out</span>'
                    : `<input type="number" id="quantita-${i}" min="0" max="${p.giacenza}" />`
                }</td>
                <td> 
                  <input type="text" id="nota-${i}" placeholder="Esempio: 1 Mario 2 Luca" style="max-width: 150px; margin: 0; padding: 0.5rem;" />
                </td> 
              </tr>`;
  });
  html += "</table>";
  document.getElementById("prodotti").innerHTML = html;
}

 function confermaOrdine() {
Â  const nome = document.getElementById("nome").value.trim();
Â  if (!nome) return alert("Seleziona il nome della tua famiglia.");

Â  localStorage.setItem("famiglia", nome);

Â  const ordine = [];
Â  for (let i = 0; i < prodotti.length; i++) {
Â  Â  const p = prodotti[i];
Â  Â  const inputQty = document.getElementById(`quantita-${i}`);
Â  Â  const inputNota = document.getElementById(`nota-${i}`);Â 
Â  Â Â 
Â  Â  if (!inputQty) continue;

Â  Â  const qty = parseInt(inputQty.value) || 0;
Â  Â  const nota = inputNota ? inputNota.value.trim() : "";Â 

Â  Â  if (qty > p.giacenza) {
Â  Â  Â  alert(`Attenzione: la giacenza del prodotto "${p.tipo}" Ã¨ inferiore alla richiesta, modificalo.`);
Â  Â  Â  return;
Â  Â  }

    // NUOVA VALIDAZIONE: Nota obbligatoria se la quantitÃ  Ã¨ > 0
    if (qty > 0 && !nota) {
      alert(`âš ï¸ Ãˆ obbligatorio specificare una nota per il prodotto "${p.tipo}".`);
      return;
    }

Â  Â  if (qty > 0) {
Â  Â  Â  ordine.push({Â 
Â  Â  Â  Â  nome,Â 
Â  Â  Â  Â  prodotto: p.tipo,Â 
Â  Â  Â  Â  quantita: qty,
Â  Â  Â  Â  nota: nota
Â  Â  Â  });
Â  Â  }
Â  }

Â  if (ordine.length === 0) return alert("Nessun prodotto selezionato.");

Â  // Aggiorna il riepilogo nel modal per includere la nota
Â  let riepilogo = `Famiglia: ${nome}\n\n`;
Â  ordine.forEach(o => {
Â  Â  let riga = `- ${o.prodotto}: ${o.quantita}`;
Â  Â  if (o.nota) { 
Â  Â  Â  Â  riga += ` (Nota: ${o.nota})`;
Â  Â  }
Â  Â  riepilogo += riga + '\n';
Â  });

Â  ordineDaInviare = ordine;
Â  document.getElementById("riepilogoModal").innerText = riepilogo;

Â  const confermaBtn = document.querySelector('#modal-content button:nth-child(4)');
Â  const annullaBtn = document.querySelector('#modal-content button:nth-child(5)');

Â  if (confermaBtn) {
Â  Â  confermaBtn.style.display = "inline-block";
Â  Â  confermaBtn.disabled = false;
Â  }
Â  if (annullaBtn) {
Â  Â  annullaBtn.style.display = "inline-block";
Â  }

Â  document.getElementById("modal").style.display = "flex";
}
  function chiudiModal() {
    document.getElementById("modal").style.display = "none";
    document.getElementById("messaggioAttesa").style.display = "none";
  }

  async function inviaOrdine() {
    const attesa = document.getElementById("messaggioAttesa");
    attesa.style.display = "block";
    try {
      const res = await fetch(scriptUrl, {
        method: "POST",
        body: JSON.stringify({ action: "prenota", ordine: ordineDaInviare })
      });
      await res.json();
      alert("âœ… Ordine inviato con successo!");
      chiudiModal();
      caricaProdotti();
    } catch (e) {
      alert("Errore invio ordine: " + e.message);
    } finally {
      attesa.style.display = "none";
    }
  }

 async function mostraRiepilogoPrenotazioni() {
Â  Â  const nominativo = document.getElementById('nome').value.trim();
Â  Â  if (!nominativo) return alert("Seleziona prima un nominativo.");

Â  Â  const spinner = document.getElementById("spinner-riepilogo");
Â  Â  const contenuto = document.getElementById("contenuto-riepilogo");
Â  Â  contenuto.innerHTML = "";Â 
Â  Â  spinner.style.display = "block";
Â  Â  document.getElementById('modal-riepilogo').style.display = "flex";

Â  Â  try {
Â  Â  Â  const url = scriptUrl + "?action=riepilogo&nominativo=" + encodeURIComponent(nominativo);
Â  Â  Â  const res = await fetch(url);
Â  Â  Â  const data = await res.json();
Â  Â  Â Â 
Â  Â  Â  riepilogoCorrente = data;
Â  Â  Â  spinner.style.display = "none";
Â  Â  Â Â 
Â  Â  Â  const prenotazioniAttive = data.filter(item => item.valore > 0);

Â  Â  Â  if (!prenotazioniAttive.length) {
Â  Â  Â  Â  contenuto.innerText = `Nessuna prenotazione attiva per ${nominativo}.`;
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  let html = `<p style="margin-bottom: 0.5rem;">Riepilogo per <strong>${nominativo}</strong>. Inserisci la quantitÃ  che desideri annullare.</p>`;
Â  Â  Â  
Â  Â  Â  // Tabella con Nota Annullamento per riga
Â  Â  Â  html += `<table style="width:100%; text-align:center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Prodotto</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Prenotati</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>QtÃ  da Annullare</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Nota Annullamento</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â Â 
Â  Â  Â  prenotazioniAttive.forEach((item, i) => {
Â  Â  Â  Â  html += `<tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td>${item.prodotto}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td><strong>${item.valore}</strong></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <input type="number" id="annulla-${i}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  min="0" max="${item.valore}" value="0"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  style="width: 70px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <input type="text" id="nota-annulla-${i}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  placeholder="Motivo" style="width: 120px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â </tr>`;
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  html += `</table>`;
Â  Â  Â  
Â  Â  Â  // POSIZIONAMENTO PULSANTI: Conferma, Dettaglio, Chiudi
Â  Â  Â  html += `<div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 1.5rem;">`
Â  Â  Â  html += `<button id="btnConfermaAnnullamento" onclick="inviaAnnullamento()" style="flex-grow: 1;">Conferma Annullamenti</button>`;
Â  Â  Â  html += `<button onclick="mostraDettaglioPerPersone(true)" style="flex-grow: 1; background-color: #0a1a3f;">Vedi Dettaglio per Persone</button>`;
Â  Â  Â  html += `<button onclick="document.getElementById('modal-riepilogo').style.display='none'" style="flex-grow: 1; background-color: #6c757d;">Chiudi</button>`;
      html += `</div>`;


Â  Â  Â  contenuto.innerHTML = html;

Â  Â  } catch (err) {
Â  Â  Â  spinner.style.display = "none";
Â  Â  Â  contenuto.innerText = "Errore: " + err.message;
Â  Â  }
Â  }
  async function inviaAnnullamento() {
Â  Â  const nome = document.getElementById("nome").value.trim();
Â  Â  const btn = document.getElementById("btnConfermaAnnullamento");
Â  Â Â 
Â  Â  btn.disabled = true;
Â  Â  btn.innerHTML = 'Elaborazione... <span class="spinner"></span>';

Â  Â  const ordineDiAnnullamento = [];
Â  Â  let errore = false;

Â  Â  const prenotazioniAttive = riepilogoCorrente.filter(item => item.valore > 0);

Â  Â  prenotazioniAttive.forEach((item, i) => {
Â  Â  Â  const inputQty = document.getElementById(`annulla-${i}`);
Â  Â  Â  const inputNota = document.getElementById(`nota-annulla-${i}`); 

Â  Â  Â  if (inputQty) {
Â  Â  Â  Â  const qtyDaAnnullare = parseInt(inputQty.value) || 0;
Â  Â  Â  Â  const notaAnnullamento = inputNota ? inputNota.value.trim() : "";

Â  Â  Â  Â  if (qtyDaAnnullare > item.valore) {
Â  Â  Â  Â  Â  alert(`Errore: Non puoi annullare ${qtyDaAnnullare} ${item.prodotto}, ne hai prenotati solo ${item.valore}.`);
Â  Â  Â  Â  Â  errore = true;
Â  Â  Â  Â  }
        
        // NUOVA VALIDAZIONE: Nota obbligatoria se la quantitÃ  da annullare Ã¨ > 0
        if (qtyDaAnnullare > 0 && !notaAnnullamento) {
          alert(`âš ï¸ Ãˆ obbligatorio specificare una nota per l'annullamento del prodotto "${item.prodotto}".`);
          errore = true;
        }

Â  Â  Â  Â  if (qtyDaAnnullare > 0 && !errore) {
Â  Â  Â  Â  Â  ordineDiAnnullamento.push({
Â  Â  Â  Â  Â  Â  nome: nome,
Â  Â  Â  Â  Â  Â  prodotto: item.prodotto,
Â  Â  Â  Â  Â  Â  quantita: -qtyDaAnnullare,
Â  Â  Â  Â  Â  Â  nota: `Annullato: ${notaAnnullamento}`
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  });

Â  Â  if (errore) {
Â  Â  Â  btn.disabled = false;
Â  Â  Â  btn.innerHTML = 'Conferma Annullamenti';
Â  Â  Â  return;
Â  Â  }

Â  Â  if (ordineDiAnnullamento.length === 0) {
Â  Â  Â  alert("Nessuna quantitÃ  da annullare inserita.");
Â  Â  Â  btn.disabled = false;
Â  Â  Â  btn.innerHTML = 'Conferma Annullamenti';
Â  Â  Â  return;
Â  Â  }

Â  Â  try {
Â  Â  Â  const res = await fetch(scriptUrl, {
Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  body: JSON.stringify({ action: "prenota", ordine: ordineDiAnnullamento })
Â  Â  Â  });
Â  Â  Â  await res.json();
Â  Â  Â Â 
Â  Â  Â  alert("âœ… Annullamento registrato con successo!");
Â  Â  Â Â 
Â  Â  Â  document.getElementById('modal-riepilogo').style.display = "none";
Â  Â  Â  caricaProdotti();Â 
Â  Â  Â Â 
Â  Â  } catch (e) {
Â  Â  Â  alert("Errore invio annullamento: " + e.message);
Â  Â  Â  btn.disabled = false;
Â  Â  Â  btn.innerHTML = 'Conferma Annullamenti';
Â  Â  }
Â  }
  // La funzione mostraDettaglioPerPersone deve essere definita come segue:

Â  // La funzione mostraDettaglioPerPersone deve essere definita come segue:

Â  async function mostraDettaglioPerPersone(chiudiRiepilogo = false) { 
Â  Â  const nominativo = document.getElementById('nome').value.trim();
Â  Â  if (!nominativo) return alert("Seleziona prima un nominativo.");

Â  Â  if (chiudiRiepilogo) {
Â  Â  Â  document.getElementById('modal-riepilogo').style.display = "none";
Â  Â  }

Â  Â  const spinner = document.getElementById("spinner-dettaglio");
Â  Â  const contenuto = document.getElementById("contenuto-dettaglio");
Â  Â  const modal = document.getElementById('modal-dettaglio-persone');
Â  Â  
Â  Â  contenuto.innerHTML = ""; 
Â  Â  document.getElementById('pulsanti-dettaglio').style.display = 'flex'; // Riabilita i pulsanti
Â  Â  spinner.style.display = "block";
Â  Â  modal.style.display = "flex";

Â  Â  try {
Â  Â  Â  Â  const url = scriptUrl + "?action=dettaglio&nominativo=" + encodeURIComponent(nominativo);
Â  Â  Â  Â  const res = await fetch(url);
Â  Â  Â  Â  const dettaglioFamiglia = await res.json();
Â  Â  Â  Â  
Â  Â  Â  Â  spinner.style.display = "none";
Â  Â  Â  Â  
Â  Â  Â  Â  if (!dettaglioFamiglia.length) {
Â  Â  Â  Â  Â  Â  contenuto.innerText = `Nessun ordine consolidato trovato nel foglio "dettaglio" per la famiglia ${nominativo}.`;
            document.getElementById('pulsanti-dettaglio').style.display = 'none';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  let html = `<h4>Riepilogo consolidato e Modifica Ordini per <strong>${nominativo}</strong>:</h4>
        <p style="margin-top: 0.2rem; font-size: 0.9em; color: #6c757d;">*Inserisci quantitÃ  positive per **Aggiungere**, negative per **Sottrarre**.</p>`;

Â  Â  Â  Â  dettaglioFamiglia.forEach((persona, pIdx) => {
Â  Â  Â  Â  Â  Â  const nomePersona = persona.nominativo;
Â  Â  Â  Â  Â  Â  html += `<div class="dettaglio-persona">`;
Â  Â  Â  Â  Â  Â  html += `<h5>ğŸ‘¤ ${nomePersona}</h5>`;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  html += `<table style="width:100%; margin-top:0.5rem; text-align:center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
                            <th>Prodotto</th>
                            <th>Attuale</th>
                            <th>Modifica (+/-)</th>
                        </tr>`;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Object.keys(persona).forEach(key => {
Â  Â  Â  Â  Â  Â  Â  Â  if (key !== 'nominativo') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${key}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><strong>${persona[key]}</strong></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>
                                <input type="number" id="modifica-${pIdx}-${key.replace(/\s/g, '_')}" 
                                       min="-${persona[key]}" value="0" 
                                       data-prodotto="${key}"
                                       data-persona="${nomePersona}"
                                       style="width: 80px;"/>
                            </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  html += `</table></div>`;
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  contenuto.innerHTML = html;

Â  Â  } catch (err) {
Â  Â  Â  Â  spinner.style.display = "none";
Â  Â  Â  Â  contenuto.innerText = "Errore nel caricamento del dettaglio: " + err.message;
Â  Â  }
Â  }

async function inviaModificaDettaglio() {
Â  Â  const nomeFamiglia = document.getElementById("nome").value.trim();
Â  Â  const btn = document.getElementById("btnApplicaModifiche");
Â  Â Â 
Â  Â  const modificheDaInviare = [];
Â  Â  let modificheTotali = 0;

Â  Â  // Cerca tutti i campi di input di modifica
Â  Â  document.querySelectorAll('[id^="modifica-"]').forEach(input => {
Â  Â  Â  Â  const modifica = parseInt(input.value) || 0;
Â  Â  Â  Â  
Â  Â  Â  Â  if (modifica !== 0) {
Â  Â  Â  Â  Â  Â  const prodotto = input.getAttribute('data-prodotto');
Â  Â  Â  Â  Â  Â  const nomePersona = input.getAttribute('data-persona');
            
            // Crea la nota automatica
            const azione = modifica > 0 ? "Aggiunta" : "Sottrazione";
            const notaAutomatica = `${azione} da ${nomePersona} (Dettaglio)`;

Â  Â  Â  Â  Â  Â  modificheDaInviare.push({
Â  Â  Â  Â  Â  Â  Â  Â  nome: nomeFamiglia,
Â  Â  Â  Â  Â  Â  Â  Â  prodotto: prodotto,
Â  Â  Â  Â  Â  Â  Â  Â  quantita: modifica, // Positivo per aggiungere, negativo per sottrarre
Â  Â  Â  Â  Â  Â  Â  Â  nota: notaAutomatica
Â  Â  Â  Â  Â  Â  });
            modificheTotali++;
Â  Â  Â  Â  }
Â  Â  });

Â  Â  if (modificheTotali === 0) {
Â  Â  Â  Â  alert("Nessuna modifica inserita. Imposta un valore positivo (Aggiungi) o negativo (Sottrai) per procedere.");
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  
Â  Â  // Conferma e Invio
Â  Â  if (!confirm(`Sei sicuro di voler inviare ${modificheTotali} modifiche d'ordine per ${nomeFamiglia}?`)) {
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  btn.disabled = true;
Â  Â  btn.innerHTML = 'Invio Modifiche... <span class="spinner"></span>';

Â  Â  try {
Â  Â  Â  Â  const res = await fetch(scriptUrl, {
Â  Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  Â  // Riutilizza l'azione 'prenota' con l'array di modifiche
Â  Â  Â  Â  Â  Â  body: JSON.stringify({ action: "prenota", ordine: modificheDaInviare })
Â  Â  Â  Â  });
Â  Â  Â  Â  await res.json();
Â  Â  Â  Â Â 
Â  Â  Â  Â  alert("âœ… Modifiche all'ordine registrate con successo!");
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('modal-dettaglio-persone').style.display = "none";
Â  Â  Â  Â  caricaProdotti(); // Ricarica la tabella principale con le nuove giacenze
Â  Â  Â  Â  
Â  Â  } catch (e) {
Â  Â  Â  Â  alert("Errore invio modifiche ordine: " + e.message);
Â  Â  } finally {
Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  btn.innerHTML = 'Applica Modifiche Ordini';
Â  Â  }
Â  }
  
  window.onload = caricaProdotti;
</script>
</body>
</html>
